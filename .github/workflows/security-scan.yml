name: Security Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  ci-filter:
    uses: ./.github/workflows/ci-filter.yml

  govulncheck:
    needs: [ci-filter]
    name: govulncheck
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      result: ${{ steps.scan.outputs.result }}
      details: ${{ steps.scan.outputs.details }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Install govulncheck
        run: go install golang.org/x/vuln/cmd/govulncheck@latest

      - name: Run govulncheck
        id: scan
        run: |
          set +e
          OUTPUT=$(govulncheck ./... 2>&1)
          EXIT_CODE=$?
          echo "$OUTPUT"

          if [ $EXIT_CODE -eq 0 ]; then
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "details=No vulnerabilities found" >> $GITHUB_OUTPUT
          else
            echo "result=fail" >> $GITHUB_OUTPUT
            VULN_COUNT=$(echo "$OUTPUT" | grep -c 'Vulnerability #' || echo "unknown")
            echo "details=Found ${VULN_COUNT} vulnerability(ies)" >> $GITHUB_OUTPUT
            exit 1
          fi

  trivy-fs:
    needs: [ci-filter]
    name: Trivy (filesystem)
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      result: ${{ steps.evaluate.outputs.result }}
      details: ${{ steps.evaluate.outputs.details }}
    steps:
      - uses: actions/checkout@v6

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Run Trivy filesystem scan (JSON)
        run: trivy fs --format json --output trivy-fs-results.json --severity CRITICAL,HIGH,MEDIUM,LOW .

      - name: Run Trivy filesystem scan (SARIF)
        run: trivy fs --format sarif --output trivy-fs.sarif --severity CRITICAL,HIGH,MEDIUM,LOW .

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-fs.sarif'
          category: 'trivy-filesystem'

      - name: Evaluate results
        id: evaluate
        run: |
          if [ ! -f trivy-fs-results.json ]; then
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "details=No findings" >> $GITHUB_OUTPUT
            exit 0
          fi

          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-fs-results.json 2>/dev/null || echo 0)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-fs-results.json 2>/dev/null || echo 0)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-fs-results.json 2>/dev/null || echo 0)
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-fs-results.json 2>/dev/null || echo 0)

          echo "details=Critical: ${CRITICAL}, High: ${HIGH}, Medium: ${MEDIUM}, Low: ${LOW}" >> $GITHUB_OUTPUT

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi

  trivy-image:
    needs: [ci-filter]
    name: Trivy (container)
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      result: ${{ steps.evaluate.outputs.result }}
      details: ${{ steps.evaluate.outputs.details }}
    steps:
      - uses: actions/checkout@v6

      - name: Install Trivy
        run: |
          sudo apt-get install -y wget apt-transport-https gnupg lsb-release
          wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | gpg --dearmor | sudo tee /usr/share/keyrings/trivy.gpg > /dev/null
          echo "deb [signed-by=/usr/share/keyrings/trivy.gpg] https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee /etc/apt/sources.list.d/trivy.list
          sudo apt-get update
          sudo apt-get install -y trivy

      - name: Build Docker image
        run: docker build -t metrics-governor:scan .

      - name: Run Trivy image scan (JSON)
        run: trivy image --format json --output trivy-image-results.json --severity CRITICAL,HIGH,MEDIUM,LOW metrics-governor:scan

      - name: Run Trivy image scan (SARIF)
        run: trivy image --format sarif --output trivy-image.sarif --severity CRITICAL,HIGH,MEDIUM,LOW metrics-governor:scan

      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: 'trivy-image.sarif'
          category: 'trivy-container'

      - name: Evaluate results
        id: evaluate
        run: |
          if [ ! -f trivy-image-results.json ]; then
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "details=No findings" >> $GITHUB_OUTPUT
            exit 0
          fi

          CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="CRITICAL")] | length' trivy-image-results.json 2>/dev/null || echo 0)
          HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="HIGH")] | length' trivy-image-results.json 2>/dev/null || echo 0)
          MEDIUM=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="MEDIUM")] | length' trivy-image-results.json 2>/dev/null || echo 0)
          LOW=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity=="LOW")] | length' trivy-image-results.json 2>/dev/null || echo 0)

          echo "details=Critical: ${CRITICAL}, High: ${HIGH}, Medium: ${MEDIUM}, Low: ${LOW}" >> $GITHUB_OUTPUT

          if [ "$CRITICAL" -gt 0 ] || [ "$HIGH" -gt 0 ]; then
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi

  gitleaks:
    needs: [ci-filter]
    name: gitleaks
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      result: ${{ steps.result.outputs.result }}
      details: ${{ steps.result.outputs.details }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install gitleaks
        run: |
          GITLEAKS_VERSION="8.21.2"
          wget -qO- "https://github.com/gitleaks/gitleaks/releases/download/v${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION}_linux_x64.tar.gz" | tar xz
          sudo mv gitleaks /usr/local/bin/

      - name: Run gitleaks
        id: gitleaks
        run: |
          set +e
          gitleaks detect --source . --verbose --redact --report-format json --report-path gitleaks-report.json 2>&1
          EXIT_CODE=$?
          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          exit 0

      - name: Set result
        id: result
        run: |
          if [ "${{ steps.gitleaks.outputs.exit_code }}" = "0" ]; then
            echo "result=pass" >> $GITHUB_OUTPUT
            echo "details=No secrets detected" >> $GITHUB_OUTPUT
          else
            echo "result=fail" >> $GITHUB_OUTPUT
            LEAK_COUNT=$(jq 'length' gitleaks-report.json 2>/dev/null || echo "unknown")
            echo "details=Found ${LEAK_COUNT} secret(s) in repository" >> $GITHUB_OUTPUT
            exit 1
          fi

  checkov:
    needs: [ci-filter]
    name: checkov
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      result: ${{ steps.evaluate.outputs.result }}
      details: ${{ steps.evaluate.outputs.details }}
    steps:
      - uses: actions/checkout@v6

      - name: Install checkov
        run: pip3 install checkov

      - name: Run checkov on Helm chart
        id: checkov_helm
        run: |
          set +e
          checkov -d helm/metrics-governor --framework helm \
            --config-file .github/checkov-config.yml \
            --output json --output-file-path checkov-helm.json \
            --quiet 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          exit 0

      - name: Run checkov on Dockerfile
        id: checkov_docker
        run: |
          set +e
          checkov -f Dockerfile --framework dockerfile \
            --output json --output-file-path checkov-docker.json \
            --quiet 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT
          exit 0

      - name: Evaluate results
        id: evaluate
        run: |
          HELM_FAILED=0
          DOCKER_FAILED=0

          if [ -f checkov-helm.json ]; then
            HELM_FAILED=$(jq '[.results.failed_checks[]? | select(.severity == "CRITICAL" or .severity == "HIGH")] | length' checkov-helm.json 2>/dev/null || echo 0)
          fi

          if [ -f checkov-docker.json ]; then
            DOCKER_FAILED=$(jq '[.results.failed_checks[]? | select(.severity == "CRITICAL" or .severity == "HIGH")] | length' checkov-docker.json 2>/dev/null || echo 0)
          fi

          echo "details=Helm: ${HELM_FAILED}, Dockerfile: ${DOCKER_FAILED}" >> $GITHUB_OUTPUT

          if [ "$HELM_FAILED" -gt 0 ] || [ "$DOCKER_FAILED" -gt 0 ]; then
            echo "result=fail" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "result=pass" >> $GITHUB_OUTPUT
          fi

  sbom:
    needs: [ci-filter]
    name: SBOM (syft)
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      result: ${{ steps.result.outputs.result }}
      details: ${{ steps.result.outputs.details }}
    steps:
      - uses: actions/checkout@v6

      - name: Install syft
        env:
          SYFT_VERSION: v1.41.2
        run: |
          curl -sSfL -o syft_linux_amd64.tar.gz \
            "https://github.com/anchore/syft/releases/download/${SYFT_VERSION}/syft_${SYFT_VERSION#v}_linux_amd64.tar.gz"
          tar -xzf syft_linux_amd64.tar.gz syft
          install syft /usr/local/bin/syft
          rm -f syft syft_linux_amd64.tar.gz
          syft version

      - name: Generate SBOM (SPDX)
        run: syft dir:. -o spdx-json=sbom-spdx.json

      - name: Generate SBOM (CycloneDX)
        run: syft dir:. -o cyclonedx-json=sbom-cyclonedx.json

      - name: Upload SBOM artifacts
        uses: actions/upload-artifact@v6
        with:
          name: sbom
          path: |
            sbom-spdx.json
            sbom-cyclonedx.json
          retention-days: 30

      - name: Set result
        id: result
        run: |
          echo "result=pass" >> $GITHUB_OUTPUT
          echo "details=Generated (SPDX + CycloneDX)" >> $GITHUB_OUTPUT

  security-gate:
    needs: [ci-filter, govulncheck, trivy-fs, trivy-image, gitleaks, checkov, sbom]
    name: security-gate
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_security != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    steps:
      - name: Evaluate security results
        run: |
          echo "=== Security Gate Evaluation ==="

          FAILED=0

          check_result() {
            local name="$1"
            local result="$2"
            local details="$3"
            if [ "$result" = "fail" ]; then
              echo "FAIL: ${name} - ${details}"
              FAILED=$((FAILED + 1))
            else
              echo "PASS: ${name} - ${details}"
            fi
          }

          check_result "govulncheck" "${{ needs.govulncheck.outputs.result }}" "${{ needs.govulncheck.outputs.details }}"
          check_result "Trivy (filesystem)" "${{ needs.trivy-fs.outputs.result }}" "${{ needs.trivy-fs.outputs.details }}"
          check_result "Trivy (container)" "${{ needs.trivy-image.outputs.result }}" "${{ needs.trivy-image.outputs.details }}"
          check_result "gitleaks" "${{ needs.gitleaks.outputs.result }}" "${{ needs.gitleaks.outputs.details }}"
          check_result "checkov" "${{ needs.checkov.outputs.result }}" "${{ needs.checkov.outputs.details }}"

          echo ""
          echo "SBOM: ${{ needs.sbom.outputs.details }} (informational)"

          if [ "$FAILED" -gt 0 ]; then
            echo ""
            echo "SECURITY GATE: FAILED (${FAILED} scanner(s) reported critical/high findings)"
            exit 1
          else
            echo ""
            echo "SECURITY GATE: PASSED"
          fi

  security-comment:
    needs: [ci-filter, govulncheck, trivy-fs, trivy-image, gitleaks, checkov, sbom, security-gate]
    name: security-comment
    runs-on: ubuntu-latest
    if: >-
      always() &&
      needs.ci-filter.outputs.skip_security != 'true' &&
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.labels.*.name, 'release:skip')
    steps:
      - name: Post security scan comment
        uses: actions/github-script@v8
        with:
          script: |
            // Collect results
            const scanners = [
              {
                name: 'govulncheck',
                result: '${{ needs.govulncheck.outputs.result }}',
                details: '${{ needs.govulncheck.outputs.details }}',
                blocks: true
              },
              {
                name: 'Trivy (filesystem)',
                result: '${{ needs.trivy-fs.outputs.result }}',
                details: '${{ needs.trivy-fs.outputs.details }}',
                blocks: true
              },
              {
                name: 'Trivy (container)',
                result: '${{ needs.trivy-image.outputs.result }}',
                details: '${{ needs.trivy-image.outputs.details }}',
                blocks: true
              },
              {
                name: 'gitleaks',
                result: '${{ needs.gitleaks.outputs.result }}',
                details: '${{ needs.gitleaks.outputs.details }}',
                blocks: true
              },
              {
                name: 'checkov',
                result: '${{ needs.checkov.outputs.result }}',
                details: '${{ needs.checkov.outputs.details }}',
                blocks: true
              },
              {
                name: 'SBOM (syft)',
                result: '${{ needs.sbom.outputs.result }}',
                details: '${{ needs.sbom.outputs.details }}',
                blocks: false
              }
            ];

            const gateResult = '${{ needs.security-gate.result }}';
            const overallPass = gateResult === 'success';
            const overallIcon = overallPass ? '\u2705' : '\u274c';
            const overallText = overallPass ? 'PASSED' : 'FAILED';

            let table = '| Scanner | Status | Findings | Blocks PR |\n';
            table += '|---------|--------|----------|-----------|\n';

            for (const s of scanners) {
              const icon = s.result === 'pass' ? '\ud83d\udfe2' : (s.result === 'fail' ? '\ud83d\udd34' : '\u26aa');
              const blocksText = s.blocks ? (s.result === 'fail' ? 'Yes' : 'No') : 'N/A';
              table += `| ${s.name} | ${icon} | ${s.details || 'N/A'} | ${blocksText} |\n`;
            }

            const timestamp = new Date().toISOString();

            const body = `## \ud83d\udd12 Security Scan Report

            | Status | Result |
            |--------|--------|
            | **Overall** | ${overallIcon} **${overallText}** |
            | **Policy** | Block on Critical/High only |

            ### Scan Results

            ${table}

            <details>
            <summary>What these scanners check</summary>

            - **govulncheck**: Go dependency vulnerabilities (call-graph aware, confirmed reachable)
            - **Trivy (filesystem)**: CVEs in go.mod, Dockerfile, YAML files
            - **Trivy (container)**: OS and application CVEs in the built Docker image
            - **gitleaks**: Leaked secrets, keys, and tokens in git history
            - **checkov**: Infrastructure-as-code misconfigurations in Helm charts and Dockerfile
            - **SBOM (syft)**: Software Bill of Materials generation (informational)

            </details>

            _Last updated: ${timestamp}_`;

            // Find existing security comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              (c.user.login === 'github-actions[bot]' || c.user.login === 'github-actions') &&
              c.body.includes('Security Scan Report')
            );

            if (botComment) {
              console.log(`Updating existing comment ${botComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              console.log('Creating new security scan comment');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
