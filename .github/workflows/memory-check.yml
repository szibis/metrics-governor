name: Memory Check

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  ci-filter:
    uses: ./.github/workflows/ci-filter.yml

  resource-tests:
    needs: [ci-filter]
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_memory != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      success: ${{ steps.run.outputs.success }}
      total: ${{ steps.run.outputs.total }}
      passed: ${{ steps.run.outputs.passed }}
      failed: ${{ steps.run.outputs.failed }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run resource tests
        id: run
        run: |
          set +e
          go test -run Resource -count=1 -timeout=5m -v ./internal/... 2>&1 | tee results.txt
          EXIT_CODE=${PIPESTATUS[0]}

          PASSED_TESTS=$(grep -c '^--- PASS:' results.txt)
          FAILED_TESTS=$(grep -c '^--- FAIL:' results.txt)
          TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))

          echo "total=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED_TESTS}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED_TESTS}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          exit $EXIT_CODE

  goroutine-leak-check:
    needs: [ci-filter]
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_memory != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      success: ${{ steps.run.outputs.success }}
      total: ${{ steps.run.outputs.total }}
      passed: ${{ steps.run.outputs.passed }}
      failed: ${{ steps.run.outputs.failed }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run goroutine leak tests
        id: run
        run: |
          set +e
          go test -run TestLeak -count=1 -timeout=5m -v ./internal/... 2>&1 | tee results.txt
          EXIT_CODE=${PIPESTATUS[0]}

          PASSED_TESTS=$(grep -c '^--- PASS:' results.txt)
          FAILED_TESTS=$(grep -c '^--- FAIL:' results.txt)
          TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))

          echo "total=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED_TESTS}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED_TESTS}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          exit $EXIT_CODE

  memory-stress-test:
    needs: [ci-filter]
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_memory != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      success: ${{ steps.run.outputs.success }}
      total: ${{ steps.run.outputs.total }}
      passed: ${{ steps.run.outputs.passed }}
      failed: ${{ steps.run.outputs.failed }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run memory stress tests
        id: run
        run: |
          set +e
          go test -run Stress -count=1 -timeout=10m -v ./internal/... 2>&1 | tee results.txt
          EXIT_CODE=${PIPESTATUS[0]}

          PASSED_TESTS=$(grep -c '^--- PASS:' results.txt)
          FAILED_TESTS=$(grep -c '^--- FAIL:' results.txt)
          TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))

          echo "total=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED_TESTS}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED_TESTS}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          exit $EXIT_CODE

  race-condition-tests:
    needs: [ci-filter]
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_memory != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      success: ${{ steps.run.outputs.success }}
      total: ${{ steps.run.outputs.total }}
      passed: ${{ steps.run.outputs.passed }}
      failed: ${{ steps.run.outputs.failed }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run race condition tests
        id: run
        run: |
          set +e
          go test -race -run 'TestRace_' -count=1 -timeout=10m -v ./internal/... 2>&1 | tee results.txt
          EXIT_CODE=${PIPESTATUS[0]}

          PASSED_TESTS=$(grep -c '^--- PASS:' results.txt)
          FAILED_TESTS=$(grep -c '^--- FAIL:' results.txt)
          TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))

          echo "total=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED_TESTS}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED_TESTS}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          exit $EXIT_CODE

  memory-leak-tests:
    needs: [ci-filter]
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_memory != 'true' &&
      !(
        github.event_name == 'pull_request' &&
        contains(github.event.pull_request.labels.*.name, 'release:skip')
      )
    outputs:
      success: ${{ steps.run.outputs.success }}
      total: ${{ steps.run.outputs.total }}
      passed: ${{ steps.run.outputs.passed }}
      failed: ${{ steps.run.outputs.failed }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Run memory leak tests
        id: run
        run: |
          set +e
          go test -run 'TestMemLeak_' -count=1 -timeout=10m -v ./internal/... 2>&1 | tee results.txt
          EXIT_CODE=${PIPESTATUS[0]}

          PASSED_TESTS=$(grep -c '^--- PASS:' results.txt)
          FAILED_TESTS=$(grep -c '^--- FAIL:' results.txt)
          TOTAL_TESTS=$((PASSED_TESTS + FAILED_TESTS))

          echo "total=${TOTAL_TESTS}" >> $GITHUB_OUTPUT
          echo "passed=${PASSED_TESTS}" >> $GITHUB_OUTPUT
          echo "failed=${FAILED_TESTS}" >> $GITHUB_OUTPUT

          if [ $EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
          fi
          exit $EXIT_CODE

  benchmark-alloc-compare:
    needs: [ci-filter]
    runs-on: ubuntu-latest
    if: >-
      needs.ci-filter.outputs.skip_memory != 'true' &&
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.labels.*.name, 'release:skip')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Run benchmarks on PR branch
        run: go test -bench=. -benchmem -benchtime=1s -count=3 -timeout=5m ./internal/... > new.txt 2>&1 || true

      - name: Run benchmarks on base branch
        run: |
          git checkout ${{ github.event.pull_request.base.sha }}
          go test -bench=. -benchmem -benchtime=1s -count=3 -timeout=5m ./internal/... > old.txt 2>&1 || true
          git checkout ${{ github.event.pull_request.head.sha }}

      - name: Compare benchmarks
        id: benchstat
        run: |
          set +e
          RESULT=$(benchstat old.txt new.txt 2>&1)
          echo "$RESULT"
          echo "$RESULT" > benchstat.txt

          # Check for allocation regressions > 10%
          REGRESSIONS=$(echo "$RESULT" | grep 'allocs/op' | grep '+' | awk '{
            # Extract the percentage change
            for (i=1; i<=NF; i++) {
              if ($i ~ /^\+[0-9]/) {
                gsub(/[+%]/, "", $i)
                if ($i+0 > 10) print $0
              }
            }
          }')

          if [ -n "$REGRESSIONS" ]; then
            echo "has_regressions=true" >> $GITHUB_OUTPUT
            echo "## Allocation Regressions (>10%)" > regression-summary.txt
            echo '```' >> regression-summary.txt
            echo "$REGRESSIONS" >> regression-summary.txt
            echo '```' >> regression-summary.txt
          else
            echo "has_regressions=false" >> $GITHUB_OUTPUT
          fi

      - name: Post benchmark comment
        if: steps.benchstat.outputs.has_regressions == 'true' && github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let summary = '';
            try {
              summary = fs.readFileSync('regression-summary.txt', 'utf8');
            } catch (e) {
              summary = 'Could not read regression summary.';
            }

            const body = `## Benchmark Allocation Regressions\n\n${summary}\n\n<details>\n<summary>Full benchstat output</summary>\n\n\`\`\`\n${fs.readFileSync('benchstat.txt', 'utf8')}\n\`\`\`\n</details>`;

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              (c.user.login === 'github-actions[bot]') &&
              c.body.includes('Benchmark Allocation Regressions')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }

  memory-check-comment:
    needs: [ci-filter, resource-tests, goroutine-leak-check, memory-stress-test, race-condition-tests, memory-leak-tests]
    runs-on: ubuntu-latest
    if: >-
      always() &&
      needs.ci-filter.outputs.skip_memory != 'true' &&
      github.event_name == 'pull_request' &&
      !contains(github.event.pull_request.labels.*.name, 'release:skip')
    steps:
      - name: Generate memory check report
        id: report
        run: |
          # Collect results with defaults
          RESOURCE_SUCCESS="${{ needs.resource-tests.outputs.success }}"
          RESOURCE_SUCCESS="${RESOURCE_SUCCESS:-false}"
          RESOURCE_TOTAL="${{ needs.resource-tests.outputs.total }}"
          RESOURCE_TOTAL="${RESOURCE_TOTAL:-0}"
          RESOURCE_PASSED="${{ needs.resource-tests.outputs.passed }}"
          RESOURCE_PASSED="${RESOURCE_PASSED:-0}"
          RESOURCE_FAILED="${{ needs.resource-tests.outputs.failed }}"
          RESOURCE_FAILED="${RESOURCE_FAILED:-0}"

          LEAK_SUCCESS="${{ needs.goroutine-leak-check.outputs.success }}"
          LEAK_SUCCESS="${LEAK_SUCCESS:-false}"
          LEAK_TOTAL="${{ needs.goroutine-leak-check.outputs.total }}"
          LEAK_TOTAL="${LEAK_TOTAL:-0}"
          LEAK_PASSED="${{ needs.goroutine-leak-check.outputs.passed }}"
          LEAK_PASSED="${LEAK_PASSED:-0}"
          LEAK_FAILED="${{ needs.goroutine-leak-check.outputs.failed }}"
          LEAK_FAILED="${LEAK_FAILED:-0}"

          STRESS_SUCCESS="${{ needs.memory-stress-test.outputs.success }}"
          STRESS_SUCCESS="${STRESS_SUCCESS:-false}"
          STRESS_TOTAL="${{ needs.memory-stress-test.outputs.total }}"
          STRESS_TOTAL="${STRESS_TOTAL:-0}"
          STRESS_PASSED="${{ needs.memory-stress-test.outputs.passed }}"
          STRESS_PASSED="${STRESS_PASSED:-0}"
          STRESS_FAILED="${{ needs.memory-stress-test.outputs.failed }}"
          STRESS_FAILED="${STRESS_FAILED:-0}"

          RACE_SUCCESS="${{ needs.race-condition-tests.outputs.success }}"
          RACE_SUCCESS="${RACE_SUCCESS:-false}"
          RACE_TOTAL="${{ needs.race-condition-tests.outputs.total }}"
          RACE_TOTAL="${RACE_TOTAL:-0}"
          RACE_PASSED="${{ needs.race-condition-tests.outputs.passed }}"
          RACE_PASSED="${RACE_PASSED:-0}"
          RACE_FAILED="${{ needs.race-condition-tests.outputs.failed }}"
          RACE_FAILED="${RACE_FAILED:-0}"

          MEMLEAK_SUCCESS="${{ needs.memory-leak-tests.outputs.success }}"
          MEMLEAK_SUCCESS="${MEMLEAK_SUCCESS:-false}"
          MEMLEAK_TOTAL="${{ needs.memory-leak-tests.outputs.total }}"
          MEMLEAK_TOTAL="${MEMLEAK_TOTAL:-0}"
          MEMLEAK_PASSED="${{ needs.memory-leak-tests.outputs.passed }}"
          MEMLEAK_PASSED="${MEMLEAK_PASSED:-0}"
          MEMLEAK_FAILED="${{ needs.memory-leak-tests.outputs.failed }}"
          MEMLEAK_FAILED="${MEMLEAK_FAILED:-0}"

          # Compute totals
          TOTAL_TESTS=$((RESOURCE_TOTAL + LEAK_TOTAL + STRESS_TOTAL + RACE_TOTAL + MEMLEAK_TOTAL))
          TOTAL_PASSED=$((RESOURCE_PASSED + LEAK_PASSED + STRESS_PASSED + RACE_PASSED + MEMLEAK_PASSED))
          TOTAL_FAILED=$((RESOURCE_FAILED + LEAK_FAILED + STRESS_FAILED + RACE_FAILED + MEMLEAK_FAILED))

          # Overall status
          if [ "$RESOURCE_SUCCESS" = "true" ] && [ "$LEAK_SUCCESS" = "true" ] && [ "$STRESS_SUCCESS" = "true" ] && [ "$RACE_SUCCESS" = "true" ] && [ "$MEMLEAK_SUCCESS" = "true" ]; then
            OVERALL_STATUS="PASS"
            OVERALL_ICON="âœ…"
          else
            OVERALL_STATUS="FAIL"
            OVERALL_ICON="âŒ"
          fi

          # Status helpers
          status_icon() {
            if [ "$1" = "true" ]; then echo "âœ… Passed"; else echo "âŒ Failed"; fi
          }

          cat > memory-comment.md << COMMENT_EOF
          ## ðŸ§  Memory Check Report

          | Status | Result |
          |--------|--------|
          | **Overall** | ${OVERALL_ICON} **${OVERALL_STATUS}** |
          | **Total Memory Tests** | ${TOTAL_TESTS} |
          | **Passed** | ${TOTAL_PASSED} |
          | **Failed** | ${TOTAL_FAILED} |

          ### Test Results

          | Suite | Tests | Passed | Failed | Status |
          |-------|:-----:|:------:|:------:|--------|
          | Resource Tests | ${RESOURCE_TOTAL} | ${RESOURCE_PASSED} | ${RESOURCE_FAILED} | $(status_icon "$RESOURCE_SUCCESS") |
          | Goroutine Leak Tests | ${LEAK_TOTAL} | ${LEAK_PASSED} | ${LEAK_FAILED} | $(status_icon "$LEAK_SUCCESS") |
          | Memory Stress Tests | ${STRESS_TOTAL} | ${STRESS_PASSED} | ${STRESS_FAILED} | $(status_icon "$STRESS_SUCCESS") |
          | Race Condition Tests | ${RACE_TOTAL} | ${RACE_PASSED} | ${RACE_FAILED} | $(status_icon "$RACE_SUCCESS") |
          | Memory Leak Tests | ${MEMLEAK_TOTAL} | ${MEMLEAK_PASSED} | ${MEMLEAK_FAILED} | $(status_icon "$MEMLEAK_SUCCESS") |
          | **Total** | **${TOTAL_TESTS}** | **${TOTAL_PASSED}** | **${TOTAL_FAILED}** | ${OVERALL_ICON} |

          <details>
          <summary>What these tests check</summary>

          - **Resource Tests**: Verify components release memory after shutdown
          - **Goroutine Leak Tests**: Verify no goroutines leaked after component lifecycle (using goleak)
          - **Memory Stress Tests**: Verify memory growth stays bounded under sustained load
          - **Race Condition Tests**: Verify concurrent access patterns are data-race free (using -race detector)
          - **Memory Leak Tests**: Verify heap growth is bounded after repeated create/destroy and reset cycles

          </details>
          COMMENT_EOF

          cat memory-comment.md

      - name: Post memory check comment
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            let comment = fs.readFileSync('memory-comment.md', 'utf8');

            // Add timestamp
            const timestamp = new Date().toISOString();
            comment += `\n\n_Last updated: ${timestamp}_`;

            // Find existing memory check comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(c =>
              (c.user.login === 'github-actions[bot]' || c.user.login === 'github-actions') &&
              c.body.includes('Memory Check Report')
            );

            if (botComment) {
              console.log(`Updating existing comment ${botComment.id}`);
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              console.log('Creating new memory check comment');
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }
