name: Benchmarks

on:
  pull_request:
    branches: [main]
    paths:
      - 'internal/**'
      - 'cmd/**'
      - 'go.mod'
      - 'go.sum'
      - 'Makefile'
  push:
    branches: [main]
    paths:
      - 'internal/**'
      - 'cmd/**'
      - 'go.mod'
      - 'go.sum'
      - 'Makefile'
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.detect.outputs.packages }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed packages
        id: detect
        run: |
          # Get changed files compared to base branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Map changed files to benchmark packages
          PACKAGES=""

          # Check each internal package
          if echo "$CHANGED_FILES" | grep -q "^internal/auth/"; then
            PACKAGES="$PACKAGES auth"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/buffer/"; then
            PACKAGES="$PACKAGES buffer"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/compression/"; then
            PACKAGES="$PACKAGES compression"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/config/"; then
            PACKAGES="$PACKAGES config"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/exporter/"; then
            PACKAGES="$PACKAGES exporter"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/limits/"; then
            PACKAGES="$PACKAGES limits"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/queue/"; then
            PACKAGES="$PACKAGES queue"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/receiver/"; then
            PACKAGES="$PACKAGES receiver"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/stats/"; then
            PACKAGES="$PACKAGES stats"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/sharding/"; then
            PACKAGES="$PACKAGES sharding"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/prw/"; then
            PACKAGES="$PACKAGES prw"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/tls/"; then
            PACKAGES="$PACKAGES tls"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/logging/"; then
            PACKAGES="$PACKAGES logging"
          fi

          # Check for common dependencies that affect all packages
          if echo "$CHANGED_FILES" | grep -qE "^(go\.mod|go\.sum|Makefile)$"; then
            PACKAGES="auth buffer compression config exporter limits logging prw queue receiver sharding stats tls"
          fi

          # Trim whitespace and convert to JSON array
          PACKAGES=$(echo "$PACKAGES" | xargs)

          if [ -z "$PACKAGES" ]; then
            echo "No benchmark-relevant changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "packages=[]" >> $GITHUB_OUTPUT
          else
            echo "Packages to benchmark: $PACKAGES"
            # Convert to JSON array
            JSON_PACKAGES=$(echo "$PACKAGES" | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "packages=$JSON_PACKAGES" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  benchmark-targeted:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.packages) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run benchmarks for ${{ matrix.package }}
        run: |
          echo "Running benchmarks for package: ${{ matrix.package }}"
          go test -bench=. -benchmem -count=5 ./internal/${{ matrix.package }}/... 2>&1 | tee benchmark-${{ matrix.package }}.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.package }}
          path: benchmark-${{ matrix.package }}.txt
          retention-days: 30

  benchmark-full:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run full benchmarks
        run: |
          go test -bench=. -benchmem -count=5 ./internal/... 2>&1 | tee benchmark-results-full.txt
          # Truncate output for benchmark-action (max 65536 chars for comments)
          # Keep only summary lines (goos, goarch, pkg, Benchmark lines, ok lines)
          grep -E '^(goos:|goarch:|pkg:|Benchmark|ok\s)' benchmark-results-full.txt > benchmark-results.txt || true
          # If still too large, keep only key benchmarks
          if [ $(wc -c < benchmark-results.txt) -gt 60000 ]; then
            echo "Benchmark results too large, filtering to key benchmarks..."
            head -n 500 benchmark-results.txt > benchmark-results-truncated.txt
            mv benchmark-results-truncated.txt benchmark-results.txt
          fi

      - name: Download previous benchmark data
        uses: actions/cache@v4
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark
          restore-keys: |
            ${{ runner.os }}-benchmark

      - name: Save benchmark baseline and history
        run: |
          mkdir -p ./cache
          cp benchmark-results.txt ./cache/benchmark-baseline.txt

          # Parse benchmark results into JSON for historical tracking
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          COMMIT_SHA="${{ github.sha }}"
          REF_NAME="${{ github.ref_name }}"

          # Create JSON entry from benchmark results
          # Format: {"timestamp": "...", "commit": "...", "ref": "...", "benchmarks": [...]}
          echo "{" > ./cache/current-benchmark.json
          echo "  \"timestamp\": \"$TIMESTAMP\"," >> ./cache/current-benchmark.json
          echo "  \"commit\": \"$COMMIT_SHA\"," >> ./cache/current-benchmark.json
          echo "  \"ref\": \"$REF_NAME\"," >> ./cache/current-benchmark.json
          echo "  \"benchmarks\": [" >> ./cache/current-benchmark.json

          # Parse benchmark lines: BenchmarkName-N  iterations  ns/op  bytes/op  allocs/op
          grep -E '^Benchmark' benchmark-results.txt | while read line; do
            NAME=$(echo "$line" | awk '{print $1}')
            ITERATIONS=$(echo "$line" | awk '{print $2}')
            NS_OP=$(echo "$line" | awk '{print $3}')
            BYTES_OP=$(echo "$line" | awk '{print $5}' | tr -d 'B/op')
            ALLOCS_OP=$(echo "$line" | awk '{print $7}' | tr -d 'allocs/op')

            echo "    {\"name\": \"$NAME\", \"iterations\": $ITERATIONS, \"ns_op\": $NS_OP, \"bytes_op\": ${BYTES_OP:-0}, \"allocs_op\": ${ALLOCS_OP:-0}}," >> ./cache/current-benchmark.json
          done

          # Close JSON array (remove trailing comma)
          sed -i '$ s/,$//' ./cache/current-benchmark.json
          echo "  ]" >> ./cache/current-benchmark.json
          echo "}" >> ./cache/current-benchmark.json

          # Append to history file (keep last 50 entries)
          if [ -f ./cache/benchmark-history.json ]; then
            # Merge current with history
            jq -s '.[1].entries = ([.[0]] + .[1].entries) | .[1].entries = .[1].entries[:50] | .[1]' \
              ./cache/current-benchmark.json ./cache/benchmark-history.json > ./cache/benchmark-history-new.json \
              2>/dev/null || echo '{"entries": []}' | jq --slurpfile current ./cache/current-benchmark.json '.entries = [$current[0]] + .entries | .entries = .entries[:50]' > ./cache/benchmark-history-new.json
            mv ./cache/benchmark-history-new.json ./cache/benchmark-history.json
          else
            jq -n --slurpfile current ./cache/current-benchmark.json '{entries: [$current[0]]}' > ./cache/benchmark-history.json
          fi

          echo "Benchmark history updated with $(jq '.entries | length' ./cache/benchmark-history.json) entries"

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-full
          path: |
            benchmark-results.txt
            benchmark-results-full.txt
            ./cache/current-benchmark.json
            ./cache/benchmark-history.json
          retention-days: 90

  compare-baseline:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [detect-changes, benchmark-targeted]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Download baseline benchmark
        uses: actions/cache@v4
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark
          restore-keys: |
            ${{ runner.os }}-benchmark

      - name: Download current benchmark results
        uses: actions/download-artifact@v4
        with:
          path: ./current
          pattern: benchmark-*

      - name: Run baseline benchmarks for changed packages
        id: baseline
        run: |
          # Get list of changed packages
          PACKAGES='${{ needs.detect-changes.outputs.packages }}'
          echo "Packages to compare: $PACKAGES"

          # Store current ref
          CURRENT_REF="${{ github.event.pull_request.head.sha }}"
          echo "Current ref: $CURRENT_REF"

          # Fetch base branch
          git fetch origin ${{ github.event.pull_request.base.ref }} --depth=1 || true

          # Checkout base branch for baseline
          echo "Checking out base: ${{ github.event.pull_request.base.sha }}"
          git checkout ${{ github.event.pull_request.base.sha }} || git checkout origin/${{ github.event.pull_request.base.ref }}

          # Run benchmarks for each changed package on base
          mkdir -p baseline
          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "Running baseline benchmark for $pkg"
            go test -bench=. -benchmem -count=5 ./internal/$pkg/... 2>&1 | tee baseline/benchmark-$pkg.txt || true
          done

          # Switch back to PR branch
          echo "Switching back to: $CURRENT_REF"
          git checkout $CURRENT_REF || git checkout -

      - name: Compare benchmarks
        id: compare
        run: |
          PACKAGES='${{ needs.detect-changes.outputs.packages }}'
          HAS_REGRESSION=false
          HAS_IMPROVEMENT=false
          REGRESSION_THRESHOLD=20
          IMPROVEMENT_THRESHOLD=10

          # Temporary file for detailed results
          echo "" > details.md

          # Arrays to track summary
          declare -a REGRESSION_PKGS
          declare -a IMPROVEMENT_PKGS
          declare -a STABLE_PKGS

          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            BASELINE_FILE="baseline/benchmark-$pkg.txt"
            CURRENT_FILE="current/benchmark-$pkg/benchmark-$pkg.txt"

            if [ -f "$BASELINE_FILE" ] && [ -f "$CURRENT_FILE" ]; then
              BENCHSTAT_OUTPUT=$(benchstat "$BASELINE_FILE" "$CURRENT_FILE" 2>&1 || echo "Error")

              # Check for regressions (> 20%)
              REGRESSIONS=$(echo "$BENCHSTAT_OUTPUT" | grep -E '\+[2-9][0-9]\.[0-9]+%|\+[0-9]{3,}\.[0-9]+%' || true)

              # Check for improvements (> 10%)
              IMPROVEMENTS=$(echo "$BENCHSTAT_OUTPUT" | grep -E '\-[1-9][0-9]\.[0-9]+%|\-[0-9]{3,}\.[0-9]+%' || true)

              if [ -n "$REGRESSIONS" ]; then
                HAS_REGRESSION=true
                REGRESSION_PKGS+=("$pkg")
                echo "### ðŸ”´ Package: \`$pkg\` - Regression Detected" >> details.md
                echo "" >> details.md
                echo "<details open>" >> details.md
                echo "<summary>Benchmark Details</summary>" >> details.md
                echo "" >> details.md
                echo "\`\`\`" >> details.md
                echo "$BENCHSTAT_OUTPUT" >> details.md
                echo "\`\`\`" >> details.md
                echo "" >> details.md
                echo "**Regressions (>${REGRESSION_THRESHOLD}%):**" >> details.md
                echo "\`\`\`" >> details.md
                echo "$REGRESSIONS" >> details.md
                echo "\`\`\`" >> details.md
                echo "</details>" >> details.md
                echo "" >> details.md
              elif [ -n "$IMPROVEMENTS" ]; then
                HAS_IMPROVEMENT=true
                IMPROVEMENT_PKGS+=("$pkg")
                echo "### ðŸŸ¢ Package: \`$pkg\` - Improvement Detected" >> details.md
                echo "" >> details.md
                echo "<details>" >> details.md
                echo "<summary>Benchmark Details</summary>" >> details.md
                echo "" >> details.md
                echo "\`\`\`" >> details.md
                echo "$BENCHSTAT_OUTPUT" >> details.md
                echo "\`\`\`" >> details.md
                echo "" >> details.md
                echo "**Improvements (>${IMPROVEMENT_THRESHOLD}%):**" >> details.md
                echo "\`\`\`" >> details.md
                echo "$IMPROVEMENTS" >> details.md
                echo "\`\`\`" >> details.md
                echo "</details>" >> details.md
                echo "" >> details.md
              else
                STABLE_PKGS+=("$pkg")
              fi
            fi
          done

          # Build the final comment
          echo "## ðŸŽï¸ Benchmark Comparison" > comparison.md
          echo "" >> comparison.md
          echo "<a name=\"benchmark-comparison\"></a>" >> comparison.md
          echo "" >> comparison.md

          # Summary table
          echo "| Status | Packages |" >> comparison.md
          echo "|--------|----------|" >> comparison.md

          if [ ${#REGRESSION_PKGS[@]} -gt 0 ]; then
            echo "| ðŸ”´ **Regression** | ${REGRESSION_PKGS[*]} |" >> comparison.md
          fi
          if [ ${#IMPROVEMENT_PKGS[@]} -gt 0 ]; then
            echo "| ðŸŸ¢ **Improved** | ${IMPROVEMENT_PKGS[*]} |" >> comparison.md
          fi
          if [ ${#STABLE_PKGS[@]} -gt 0 ]; then
            echo "| âšª **Stable** | ${STABLE_PKGS[*]} |" >> comparison.md
          fi

          echo "" >> comparison.md

          # Add details if there are regressions or improvements
          if [ "$HAS_REGRESSION" = "true" ] || [ "$HAS_IMPROVEMENT" = "true" ]; then
            cat details.md >> comparison.md
          else
            echo "âœ… **All benchmarks are stable** - no significant changes detected (threshold: Â±${REGRESSION_THRESHOLD}%)" >> comparison.md
          fi

          echo "" >> comparison.md
          echo "---" >> comparison.md

          if [ "$HAS_REGRESSION" = "true" ]; then
            echo "### âš ï¸ Action Required" >> comparison.md
            echo "" >> comparison.md
            echo "Performance regressions detected (>${REGRESSION_THRESHOLD}%). Please review before merging." >> comparison.md
            echo "has_regression=true" >> $GITHUB_OUTPUT
          else
            echo "### âœ… Ready to Merge" >> comparison.md
            echo "" >> comparison.md
            echo "No performance regressions detected." >> comparison.md
            echo "has_regression=false" >> $GITHUB_OUTPUT
          fi

          echo "" >> comparison.md
          echo "_Thresholds: Regression >${REGRESSION_THRESHOLD}%, Improvement >${IMPROVEMENT_THRESHOLD}%_" >> comparison.md

          cat comparison.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.md', 'utf8');

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              (comment.user.login === 'github-actions[bot]' || comment.user.login === 'github-actions') &&
              comment.body.includes('Benchmark Comparison')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comparison
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comparison
              });
            }

  generate-summary:
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [detect-changes, benchmark-targeted, compare-baseline]
    steps:
      - name: Generate PR Summary
        run: |
          echo "## Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PACKAGES='${{ needs.detect-changes.outputs.packages }}'
          if [ "$PACKAGES" == "[]" ] || [ -z "$PACKAGES" ]; then
            echo "No benchmark-relevant changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          else
            echo "Benchmarks were run for the following packages:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for pkg in $(echo "$PACKAGES" | jq -r '.[]' 2>/dev/null || echo ""); do
              echo "- \`internal/$pkg\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Alert Threshold" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Alert threshold: **150%** of baseline (50% regression)" >> $GITHUB_STEP_SUMMARY
          echo "- Warning threshold: **120%** of baseline (20% regression)" >> $GITHUB_STEP_SUMMARY
