name: Benchmarks

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      packages: ${{ steps.detect.outputs.packages }}
      has_changes: ${{ steps.detect.outputs.has_changes }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changed packages
        id: detect
        run: |
          # Get changed files compared to base branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_SHA=${{ github.event.pull_request.base.sha }}
            HEAD_SHA=${{ github.event.pull_request.head.sha }}
            CHANGED_FILES=$(git diff --name-only $BASE_SHA $HEAD_SHA)
          else
            # For push events, compare with previous commit
            CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git diff --name-only HEAD)
          fi

          echo "Changed files:"
          echo "$CHANGED_FILES"

          # Map changed files to benchmark packages
          PACKAGES=""

          # Check each internal package
          if echo "$CHANGED_FILES" | grep -q "^internal/auth/"; then
            PACKAGES="$PACKAGES auth"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/buffer/"; then
            PACKAGES="$PACKAGES buffer"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/compression/"; then
            PACKAGES="$PACKAGES compression"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/config/"; then
            PACKAGES="$PACKAGES config"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/exporter/"; then
            PACKAGES="$PACKAGES exporter"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/limits/"; then
            PACKAGES="$PACKAGES limits"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/queue/"; then
            PACKAGES="$PACKAGES queue"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/receiver/"; then
            PACKAGES="$PACKAGES receiver"
          fi
          if echo "$CHANGED_FILES" | grep -q "^internal/stats/"; then
            PACKAGES="$PACKAGES stats"
          fi

          # Check for common dependencies that affect all packages
          if echo "$CHANGED_FILES" | grep -qE "^(go\.mod|go\.sum|Makefile)$"; then
            PACKAGES="auth buffer compression config exporter limits queue receiver stats"
          fi

          # Trim whitespace and convert to JSON array
          PACKAGES=$(echo "$PACKAGES" | xargs)

          if [ -z "$PACKAGES" ]; then
            echo "No benchmark-relevant changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "packages=[]" >> $GITHUB_OUTPUT
          else
            echo "Packages to benchmark: $PACKAGES"
            # Convert to JSON array
            JSON_PACKAGES=$(echo "$PACKAGES" | tr ' ' '\n' | jq -R . | jq -s -c .)
            echo "packages=$JSON_PACKAGES" >> $GITHUB_OUTPUT
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

  benchmark-targeted:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.has_changes == 'true' && github.event_name == 'pull_request'
    strategy:
      matrix:
        package: ${{ fromJson(needs.detect-changes.outputs.packages) }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run benchmarks for ${{ matrix.package }}
        run: |
          echo "Running benchmarks for package: ${{ matrix.package }}"
          go test -bench=. -benchmem -count=5 ./internal/${{ matrix.package }}/... 2>&1 | tee benchmark-${{ matrix.package }}.txt

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-${{ matrix.package }}
          path: benchmark-${{ matrix.package }}.txt
          retention-days: 30

  benchmark-full:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/tags/v')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Run full benchmarks
        run: |
          go test -bench=. -benchmem -count=5 ./internal/... 2>&1 | tee benchmark-results-full.txt
          # Truncate output for benchmark-action (max 65536 chars for comments)
          # Keep only summary lines (goos, goarch, pkg, Benchmark lines, ok lines)
          grep -E '^(goos:|goarch:|pkg:|Benchmark|ok\s)' benchmark-results-full.txt > benchmark-results.txt || true
          # If still too large, keep only key benchmarks
          if [ $(wc -c < benchmark-results.txt) -gt 60000 ]; then
            echo "Benchmark results too large, filtering to key benchmarks..."
            head -n 500 benchmark-results.txt > benchmark-results-truncated.txt
            mv benchmark-results-truncated.txt benchmark-results.txt
          fi

      - name: Download previous benchmark data
        uses: actions/cache@v4
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark
          restore-keys: |
            ${{ runner.os }}-benchmark

      - name: Store benchmark result
        uses: benchmark-action/github-action-benchmark@v1
        with:
          name: Go Benchmarks
          tool: 'go'
          output-file-path: benchmark-results.txt
          external-data-json-path: ./cache/benchmark-data.json
          # Don't fail on alert - CI benchmarks have high variance
          # Real regressions should be caught in code review
          fail-on-alert: false
          alert-threshold: '200%'
          comment-on-alert: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
          auto-push: false
          # Disabled to avoid "body is too long" error (max 65536 chars)
          comment-always: false
          summary-always: false

      - name: Save benchmark baseline
        run: |
          mkdir -p ./cache
          cp benchmark-results.txt ./cache/benchmark-baseline.txt

      - name: Upload benchmark artifacts
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-full
          path: |
            benchmark-results.txt
            benchmark-results-full.txt
          retention-days: 90

  compare-baseline:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: [detect-changes, benchmark-targeted]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Install benchstat
        run: go install golang.org/x/perf/cmd/benchstat@latest

      - name: Download baseline benchmark
        uses: actions/cache@v4
        with:
          path: ./cache
          key: ${{ runner.os }}-benchmark
          restore-keys: |
            ${{ runner.os }}-benchmark

      - name: Download current benchmark results
        uses: actions/download-artifact@v4
        with:
          path: ./current
          pattern: benchmark-*

      - name: Run baseline benchmarks for changed packages
        id: baseline
        run: |
          # Get list of changed packages
          PACKAGES='${{ needs.detect-changes.outputs.packages }}'
          echo "Packages to compare: $PACKAGES"

          # Checkout base branch for baseline
          git fetch origin ${{ github.event.pull_request.base.ref }}
          git checkout ${{ github.event.pull_request.base.sha }}

          # Run benchmarks for each changed package on base
          mkdir -p baseline
          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "Running baseline benchmark for $pkg"
            go test -bench=. -benchmem -count=5 ./internal/$pkg/... 2>&1 | tee baseline/benchmark-$pkg.txt || true
          done

          # Switch back to PR branch
          git checkout ${{ github.event.pull_request.head.sha }}

      - name: Compare benchmarks
        id: compare
        run: |
          echo "## Benchmark Comparison (PR vs Base)" > comparison.md
          echo "" >> comparison.md
          echo "Comparing benchmarks for changed packages against base branch." >> comparison.md
          echo "" >> comparison.md

          PACKAGES='${{ needs.detect-changes.outputs.packages }}'
          HAS_REGRESSION=false

          for pkg in $(echo "$PACKAGES" | jq -r '.[]'); do
            echo "### Package: \`$pkg\`" >> comparison.md
            echo "" >> comparison.md

            BASELINE_FILE="baseline/benchmark-$pkg.txt"
            CURRENT_FILE="current/benchmark-$pkg/benchmark-$pkg.txt"

            if [ -f "$BASELINE_FILE" ] && [ -f "$CURRENT_FILE" ]; then
              echo "\`\`\`" >> comparison.md
              benchstat "$BASELINE_FILE" "$CURRENT_FILE" >> comparison.md 2>&1 || echo "Error comparing benchmarks" >> comparison.md
              echo "\`\`\`" >> comparison.md

              # Check for regressions (> 20%)
              REGRESSIONS=$(benchstat "$BASELINE_FILE" "$CURRENT_FILE" 2>&1 | grep -E '\+[2-9][0-9]\.[0-9]+%|\+[0-9]{3,}\.[0-9]+%' || true)
              if [ -n "$REGRESSIONS" ]; then
                echo "" >> comparison.md
                echo "⚠️ **Potential regressions detected (>20%):**" >> comparison.md
                echo "\`\`\`" >> comparison.md
                echo "$REGRESSIONS" >> comparison.md
                echo "\`\`\`" >> comparison.md
                HAS_REGRESSION=true
              fi
            else
              echo "⚠️ Could not compare - missing baseline or current results" >> comparison.md
            fi
            echo "" >> comparison.md
          done

          if [ "$HAS_REGRESSION" = "true" ]; then
            echo "" >> comparison.md
            echo "---" >> comparison.md
            echo "### ⚠️ Performance Regression Warning" >> comparison.md
            echo "" >> comparison.md
            echo "One or more benchmarks show >20% regression. Please review the changes." >> comparison.md
            echo "has_regression=true" >> $GITHUB_OUTPUT
          else
            echo "" >> comparison.md
            echo "---" >> comparison.md
            echo "### ✅ No Significant Regressions" >> comparison.md
            echo "" >> comparison.md
            echo "All benchmarks are within acceptable thresholds." >> comparison.md
            echo "has_regression=false" >> $GITHUB_OUTPUT
          fi

          cat comparison.md >> $GITHUB_STEP_SUMMARY

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.md', 'utf8');

            // Find and update existing comment or create new one
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Benchmark Comparison')
            );

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comparison
              });
            } else {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comparison
              });
            }

  generate-summary:
    runs-on: ubuntu-latest
    if: always() && github.event_name == 'pull_request'
    needs: [detect-changes, benchmark-targeted, compare-baseline]
    steps:
      - name: Generate PR Summary
        run: |
          echo "## Benchmark Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          PACKAGES='${{ needs.detect-changes.outputs.packages }}'
          if [ "$PACKAGES" == "[]" ] || [ -z "$PACKAGES" ]; then
            echo "No benchmark-relevant changes detected in this PR." >> $GITHUB_STEP_SUMMARY
          else
            echo "Benchmarks were run for the following packages:" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            for pkg in $(echo "$PACKAGES" | jq -r '.[]' 2>/dev/null || echo ""); do
              echo "- \`internal/$pkg\`" >> $GITHUB_STEP_SUMMARY
            done
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Performance Alert Threshold" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Alert threshold: **150%** of baseline (50% regression)" >> $GITHUB_STEP_SUMMARY
          echo "- Warning threshold: **120%** of baseline (20% regression)" >> $GITHUB_STEP_SUMMARY
