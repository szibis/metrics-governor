# Performance testing configuration - high volume stress testing
# Usage: docker compose -f docker-compose.yaml -f compose_overrides/perf.yaml up -d
#
# This override maximizes data volume for:
# - Stress testing
# - Performance benchmarking
# - Capacity planning
# - High cardinality testing

services:
  metrics-generator:
    environment:
      - OTLP_ENDPOINT=otel-collector:4317
      - METRICS_INTERVAL=50ms         # Fast generation
      - SERVICES=payment-api,order-api,inventory-api,user-api,auth-api,legacy-app,billing-api,notification-api,search-api,analytics-api
      - ENVIRONMENTS=prod,staging,dev,qa
      - ENABLE_EDGE_CASES=true
      - ENABLE_HIGH_CARDINALITY=true
      - ENABLE_BURST_TRAFFIC=true
      - ENABLE_DIVERSE_METRICS=true
      - HIGH_CARDINALITY_COUNT=500    # High cardinality
      - DIVERSE_METRIC_COUNT=300      # Many unique metrics
      - BURST_SIZE=5000               # Large bursts
      - BURST_INTERVAL_SEC=15         # Frequent bursts
      - STATS_INTERVAL_SEC=5
      - TARGET_METRICS_PER_SEC=100000
      - TARGET_DATAPOINTS_PER_SEC=200000
      - METRICS_PORT=9091
      # Spike scenario configuration (enabled for stress testing)
      - ENABLE_SPIKE_SCENARIOS=true
      - SPIKE_MODE=realistic
      - SPIKE_CARDINALITY=1000
      - SPIKE_DURATION_SEC=15
      - SPIKE_INTERVAL_MIN_SEC=10
      - SPIKE_INTERVAL_MAX_SEC=30
      - MISTAKE_DELAY_SEC=20
      - MISTAKE_DURATION_SEC=60
      - MISTAKE_CARDINALITY_RATE=100
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2"

  metrics-governor:
    command:
      - "-exporter-endpoint=http://victoriametrics:8428/opentelemetry/v1/metrics"
      - "-exporter-protocol=http"
      - "-exporter-insecure=true"
      - "-exporter-compression=zstd"
      - "-stats-labels=service,env"
      - "-limits-config=/etc/metrics-governor/limits.yaml"
      - "-limits-dry-run=false"       # Actually enforce limits
      - "-flush-interval=50ms"        # Fast flushing
      - "-batch-size=500"             # Larger batches
      - "-max-batch-bytes=8388608"    # 8MB byte-aware batch splitting
      - "-buffer-size=50000"          # Large buffer
      # Performance tuning for high-throughput scenarios
      - "-export-concurrency=64"      # Higher concurrency for perf testing
      - "-string-interning=true"
      - "-intern-max-value-length=64"
      # Disk queue - persistent failover (5GB for high-volume perf testing)
      - "-queue-enabled=true"
      - "-queue-type=disk"
      - "-queue-path=/data/queue"
      - "-queue-max-size=50000"
      - "-queue-max-bytes=5368709120"      # 5GB disk queue
      - "-queue-retry-interval=2s"
      - "-queue-full-behavior=drop_oldest"
      - "-queue-adaptive-enabled=true"
      - "-queue-inmemory-blocks=512"       # Larger in-memory buffer for throughput
      - "-queue-chunk-size=268435456"      # 256MB chunks for perf
      - "-queue-meta-sync=500ms"
      - "-queue-stale-flush=2s"
      # Queue resilience (optimized for high load)
      - "-queue-backoff-enabled=true"
      - "-queue-backoff-multiplier=1.5"  # Less aggressive backoff
      - "-queue-circuit-breaker-enabled=true"
      - "-queue-circuit-breaker-threshold=20"  # Higher threshold for perf
      - "-queue-circuit-breaker-reset-timeout=15s"
      # Rule cache - larger LRU cache for high-cardinality perf testing
      - "-rule-cache-max-size=50000"
      # Memory limit (more headroom for perf testing)
      - "-memory-limit-ratio=0.85"
    volumes:
      - mg-queue-perf-data:/data/queue
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: "2"

  victoriametrics:
    deploy:
      resources:
        limits:
          memory: 16G                 # More memory for high volume
          cpus: "4"
    command:
      - "--storageDataPath=/victoria-metrics-data"
      - "--httpListenAddr=:8428"
      - "--retentionPeriod=1d"
      - "--search.latencyOffset=0s"
      - "--promscrape.config=/etc/victoriametrics/scrape.yaml"
      - "--maxInsertRequestSize=256MB"
      - "--opentelemetry.maxRequestSize=256MB"
      - "--opentelemetry.convertMetricNamesToPrometheus"
      - "--memory.allowedPercent=85"
      - "--search.maxUniqueTimeseries=5000000"
      - "--search.maxConcurrentRequests=64"
      - "--search.maxQueryDuration=30s"
      - "--search.logSlowQueryDuration=10s"

  otel-collector:
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "2"

  verifier:
    environment:
      - VM_ENDPOINT=http://victoriametrics:8428
      - MG_ENDPOINT=http://metrics-governor:9090
      - CHECK_INTERVAL=10s            # More frequent checks
      - VERIFICATION_METRIC=generator_verification_counter
      - PASS_THRESHOLD=95.0
      - METRICS_PORT=9092

volumes:
  mg-queue-perf-data:
    driver: local
