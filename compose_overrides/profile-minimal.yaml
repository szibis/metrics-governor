# Minimal profile stress test - push to resource limits
# Usage: docker compose -f docker-compose.yaml -f compose_overrides/profile-minimal.yaml up -d
#
# Tests the minimal profile at its resource ceiling:
# - 0.5 CPU, 256 MB memory, NO disk queue
# - Generator sends ~10k dps (profile's max throughput)
# - Should run stable without OOM or CPU throttling
# - Verifier threshold 90% (some loss expected under pressure)
#
# Total resource budget: 3.5 CPU, 2.75 GB memory

services:
  otel-collector:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1"

  metrics-generator:
    environment:
      - OTLP_ENDPOINT=otel-collector:4317
      - METRICS_INTERVAL=500ms
      - SERVICES=test-svc
      - ENVIRONMENTS=prod
      - ENABLE_EDGE_CASES=false
      - ENABLE_HIGH_CARDINALITY=false
      - ENABLE_BURST_TRAFFIC=false
      - ENABLE_DIVERSE_METRICS=true
      - DIVERSE_METRIC_COUNT=20
      - HIGH_CARDINALITY_COUNT=10
      - TARGET_METRICS_PER_SEC=5000
      - TARGET_DATAPOINTS_PER_SEC=10000
      - STATS_INTERVAL_SEC=15
      - ENABLE_SPIKE_SCENARIOS=false
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "0.5"

  metrics-governor:
    command:
      - "--profile=minimal"
      - "-exporter-endpoint=http://victoriametrics:8428/opentelemetry/v1/metrics"
      - "-exporter-protocol=http"
      - "-exporter-insecure=true"
      - "-stats-labels=service,env"
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.5"

  victoriametrics:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"

  verifier:
    environment:
      - PASS_THRESHOLD=90.0
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  grafana:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"
