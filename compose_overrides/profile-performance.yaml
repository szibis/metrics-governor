# Performance profile stress test - push to resource limits with full pipeline
# Usage: docker compose -f docker-compose.yaml -f compose_overrides/profile-performance.yaml up -d
#
# Tests the performance profile with pipeline split + adaptive workers:
# - 4 CPU, 4 GB memory, disk queue
# - Generator sends ~15k dps (exercises pipeline split + zstd + adaptive workers)
# - Verifier threshold 90%
#
# Total resource budget: 9 CPU, 5 GB memory (fits Docker Desktop with 8 GB)
# For full 500k dps testing, use a machine with 32+ GB RAM and increase targets.

services:
  otel-collector:
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1"

  metrics-generator:
    environment:
      - OTLP_ENDPOINT=otel-collector:4317
      - OTEL_EXPORTER_OTLP_METRICS_TEMPORALITY_PREFERENCE=lowmemory
      - METRICS_INTERVAL=500ms
      - SERVICES=payment-api,order-api
      - ENVIRONMENTS=prod
      - ENABLE_EDGE_CASES=false
      - ENABLE_HIGH_CARDINALITY=true
      - ENABLE_BURST_TRAFFIC=false
      - ENABLE_DIVERSE_METRICS=true
      - HIGH_CARDINALITY_COUNT=20
      - DIVERSE_METRIC_COUNT=30
      - TARGET_METRICS_PER_SEC=7500
      - TARGET_DATAPOINTS_PER_SEC=15000
      - STATS_INTERVAL_SEC=10
      - ENABLE_SPIKE_SCENARIOS=false
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "1"

  metrics-governor:
    command:
      - "--profile=performance"
      - "-exporter-endpoint=http://victoriametrics:8428/opentelemetry/v1/metrics"
      - "-exporter-protocol=http"
      - "-exporter-insecure=true"
      - "-exporter-compression=zstd"
      - "-stats-labels=service,env"
      - "-limits-config=/etc/metrics-governor/limits.yaml"
      - "-limits-dry-run=false"
      - "-queue-path=/data/queue"
    volumes:
      - ./examples/limits.yaml:/etc/metrics-governor/limits.yaml:ro
      - mg-queue-perf-profile-data:/data/queue
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: "4"

  victoriametrics:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "2.5"

  verifier:
    environment:
      - CHECK_INTERVAL=15s
      - PASS_THRESHOLD=90.0
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

  grafana:
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: "0.25"

volumes:
  mg-queue-perf-profile-data:
    driver: local
