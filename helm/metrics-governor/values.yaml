# Default values for metrics-governor
# This is a YAML-formatted file.

# -- Global settings
global:
  # -- Image registry to use for all images
  imageRegistry: ""
  # -- Image pull secrets for all images
  imagePullSecrets: []
  # -- Cluster domain suffix
  clusterDomainSuffix: cluster.local

# -- Number of replicas (ignored for DaemonSet)
replicaCount: 1

# -- Deployment mode: "deployment", "statefulset", or "daemonset"
kind: deployment

image:
  # -- Image registry
  registry: ""
  # -- Image repository
  repository: metrics-governor/metrics-governor
  # -- Image pull policy
  pullPolicy: IfNotPresent
  # -- Image tag (defaults to appVersion)
  tag: ""

# -- Image pull secrets
imagePullSecrets: []

# -- Override the name
nameOverride: ""

# -- Override the fullname
fullnameOverride: ""

# -- Extra labels for all resources
extraLabels: {}

# -- Annotations for all resources
annotations: {}

# -- Pod annotations
podAnnotations: {}

# -- Pod labels
podLabels: {}

serviceAccount:
  # -- Create service account
  create: true
  # -- Annotations for service account
  annotations: {}
  # -- Name of the service account (generated if not set)
  name: ""
  # -- Automount API credentials
  automountServiceAccountToken: true

rbac:
  # -- Create RBAC resources
  create: true
  # -- Create cluster-wide resources
  clusterWide: false
  # -- Extra rules for the role
  extraRules: []
  # -- Annotations for RBAC resources
  annotations: {}

podSecurityContext:
  # -- Run as non-root
  runAsNonRoot: true
  # -- Run as user
  runAsUser: 1000
  # -- Run as group
  runAsGroup: 1000
  # -- FS group
  fsGroup: 1000

securityContext:
  # -- Read only root filesystem
  readOnlyRootFilesystem: true
  # -- Allow privilege escalation
  allowPrivilegeEscalation: false
  # -- Drop all capabilities
  capabilities:
    drop:
      - ALL

# -- Container ports
ports:
  grpc: 4317
  http: 4318
  stats: 9090

# -- metrics-governor configuration
config:
  # -- gRPC listen address
  grpcListen: ":4317"
  # -- HTTP listen address
  httpListen: ":4318"
  # -- Stats/metrics HTTP endpoint address
  statsAddr: ":9090"
  # -- OTLP exporter endpoint
  exporterEndpoint: "localhost:4317"
  # -- Exporter protocol: "grpc" or "http"
  exporterProtocol: "grpc"
  # -- Use insecure connection for exporter
  exporterInsecure: true
  # -- Exporter request timeout
  exporterTimeout: "30s"
  # -- Maximum number of metrics to buffer
  bufferSize: 10000
  # -- Buffer flush interval
  flushInterval: "5s"
  # -- Maximum batch size for export
  batchSize: 1000
  # -- Comma-separated labels to track
  statsLabels: ""
  # -- Dry run mode for limits
  limitsDryRun: true
  # -- Extra CLI arguments (advanced use only; prefer config file settings)
  extraArgs: []
  # -- Raw YAML config override.
  # When set, this is used verbatim as config.yaml instead of the template-generated config.
  # This gives full control over all configuration options.
  # Example:
  #   rawConfig: |
  #     receiver:
  #       grpc:
  #         address: ":4317"
  #       http:
  #         address: ":4318"
  #     exporter:
  #       endpoint: "otel-collector:4317"
  #       protocol: "grpc"
  #       insecure: true
  #     buffer:
  #       size: 10000
  #       batch_size: 1000
  #       flush_interval: "5s"
  #     stats:
  #       address: ":9090"
  #     limits:
  #       dry_run: true
  rawConfig: ""

# -- Receiver TLS configuration
receiverTLS:
  # -- Enable TLS for receivers
  enabled: false
  # -- Secret containing TLS certificate and key
  secretName: ""
  # -- Certificate file key in secret
  certKey: "tls.crt"
  # -- Key file key in secret
  keyKey: "tls.key"
  # -- CA certificate for client verification (mTLS)
  caSecretName: ""
  # -- CA certificate key in secret
  caKey: "ca.crt"
  # -- Require client certificates (mTLS)
  clientAuth: false

# -- Receiver authentication configuration
receiverAuth:
  # -- Enable authentication for receivers
  enabled: false
  # -- Bearer token for authentication (from secret)
  bearerTokenSecretName: ""
  # -- Key in secret containing bearer token
  bearerTokenKey: "token"
  # -- Basic auth username (from secret)
  basicAuthSecretName: ""
  # -- Username key in secret
  usernameKey: "username"
  # -- Password key in secret
  passwordKey: "password"

# -- Exporter TLS configuration
exporterTLS:
  # -- Enable custom TLS config for exporter
  enabled: false
  # -- Secret containing client certificate and key (mTLS)
  secretName: ""
  # -- Certificate file key in secret
  certKey: "tls.crt"
  # -- Key file key in secret
  keyKey: "tls.key"
  # -- CA certificate for server verification
  caSecretName: ""
  # -- CA certificate key in secret
  caKey: "ca.crt"
  # -- Skip TLS certificate verification
  insecureSkipVerify: false
  # -- Override server name for TLS verification
  serverName: ""

# -- Exporter authentication configuration
exporterAuth:
  # -- Bearer token for authentication (from secret)
  bearerTokenSecretName: ""
  # -- Key in secret containing bearer token
  bearerTokenKey: "token"
  # -- Basic auth credentials (from secret)
  basicAuthSecretName: ""
  # -- Username key in secret
  usernameKey: "username"
  # -- Password key in secret
  passwordKey: "password"
  # -- Custom headers for exporter (format: "key1=value1,key2=value2")
  headers: ""

# -- Exporter compression configuration (HTTP only)
exporterCompression:
  # -- Compression type: none, gzip, zstd, snappy, zlib, deflate
  type: "none"
  # -- Compression level (algorithm-specific, 0 for default)
  level: 0

# -- Exporter HTTP client configuration
exporterHTTPClient:
  # -- Maximum idle connections across all hosts
  maxIdleConns: 100
  # -- Maximum idle connections per host
  maxIdleConnsPerHost: 100
  # -- Maximum total connections per host (0 = no limit)
  maxConnsPerHost: 0
  # -- Idle connection timeout
  idleConnTimeout: "90s"
  # -- Disable HTTP keep-alives
  disableKeepAlives: false
  # -- Force HTTP/2 for non-TLS connections
  forceHTTP2: false
  # -- HTTP/2 read idle timeout for health checks
  http2ReadIdleTimeout: ""
  # -- HTTP/2 ping timeout
  http2PingTimeout: ""

# -- Persistent queue configuration for export retries (FastQueue-based)
queue:
  # -- Enable persistent queue
  enabled: false
  # -- Queue storage directory (must be writable, use persistence for StatefulSet)
  path: "/data/queue"
  # -- Maximum number of batches in queue
  maxSize: 10000
  # -- Maximum total queue size in bytes (1GB default)
  maxBytes: 1073741824
  # -- Initial retry interval
  retryInterval: "5s"
  # -- Maximum retry backoff delay
  maxRetryDelay: "5m"
  # -- Queue full behavior: drop_oldest, drop_newest, or block
  fullBehavior: "drop_oldest"
  # -- Target disk utilization for adaptive sizing (0.0-1.0)
  targetUtilization: 0.85
  # -- Enable adaptive queue sizing based on disk space
  adaptiveEnabled: true
  # -- In-memory channel size (number of blocks)
  inmemoryBlocks: 256
  # -- Chunk file size for disk storage
  chunkSize: "512MB"
  # -- Metadata sync interval
  metaSyncInterval: "1s"
  # -- Stale flush interval (flush in-memory to disk)
  staleFlushInterval: "5s"

# -- Receiver HTTP server configuration
receiverHTTPServer:
  # -- Maximum request body size in bytes (0 = no limit)
  maxRequestBodySize: 0
  # -- HTTP server read timeout (empty = no timeout)
  readTimeout: ""
  # -- HTTP server read header timeout
  readHeaderTimeout: "1m"
  # -- HTTP server write timeout
  writeTimeout: "30s"
  # -- HTTP server idle timeout
  idleTimeout: "1m"
  # -- Enable HTTP keep-alives for receiver
  keepAlivesEnabled: true

# -- Performance tuning configuration
# Techniques inspired by VictoriaMetrics articles (original implementations)
performance:
  # -- Max concurrent export goroutines (0 = NumCPU * 4)
  exportConcurrency: 0
  # -- Enable string interning for label/attribute deduplication
  stringInterning: true
  # -- Max length for label value interning (longer values not interned)
  internMaxValueLength: 64

# -- Limits configuration (creates ConfigMap)
limits:
  # -- Enable limits enforcement
  enabled: false
  # -- Use existing ConfigMap for limits
  existingConfigMap: ""
  # -- Limits configuration content
  config: |
    defaults:
      max_datapoints_rate: 1000000
      max_cardinality: 100000
      action: log
    rules: []

# -- Relabeling configuration (creates ConfigMap)
relabeling:
  # -- Enable metric relabeling
  enabled: false
  # -- Use existing ConfigMap for relabeling
  existingConfigMap: ""
  # -- Relabel configuration content (Prometheus-compatible relabel_configs)
  config: |
    relabel_configs: []

# -- Sampling configuration (creates ConfigMap)
sampling:
  # -- Enable metric sampling
  enabled: false
  # -- Use existing ConfigMap for sampling
  existingConfigMap: ""
  # -- Sampling configuration content
  config: |
    default_rate: 1.0
    strategy: head
    rules: []

# -- Multi-tenancy configuration
tenancy:
  # -- Enable multi-tenancy support
  enabled: false
  # -- Tenant detection mode: "header", "label", or "attribute"
  mode: "header"
  # -- HTTP header name for tenant ID (mode=header, Mimir/Cortex compatible)
  headerName: "X-Scope-OrgID"
  # -- Metric label name for tenant ID (mode=label)
  labelName: "tenant"
  # -- Resource attribute key for tenant ID (mode=attribute)
  attributeKey: "service.namespace"
  # -- Default tenant when detection fails
  defaultTenant: "default"
  # -- Inject tenant ID as a label on all datapoints
  injectLabel: true
  # -- Label name for injected tenant ID
  injectLabelName: "__tenant__"
  # -- Remove source label after detection (mode=label only)
  stripSource: false
  # -- Use existing ConfigMap for tenant quotas
  existingConfigMap: ""
  # -- Tenant quotas configuration content
  config: |
    default:
      max_datapoints: 100000
      max_cardinality: 50000
      action: log
      window: "1m"
    tenants: {}

service:
  # -- Enable service
  enabled: true
  # -- Service type
  type: ClusterIP
  # -- Service annotations
  annotations: {}
  # -- Service labels
  labels: {}
  # -- ClusterIP (leave empty for auto)
  clusterIP: ""
  # -- gRPC port
  grpcPort: 4317
  # -- HTTP port
  httpPort: 4318
  # -- Stats port
  statsPort: 9090
  # -- External traffic policy
  externalTrafficPolicy: ""
  # -- Load balancer IP
  loadBalancerIP: ""
  # -- Load balancer source ranges
  loadBalancerSourceRanges: []

# -- Headless service for StatefulSet
headlessService:
  enabled: true
  annotations: {}

serviceMonitor:
  # -- Enable ServiceMonitor
  enabled: false
  # -- Namespace for ServiceMonitor (defaults to release namespace)
  namespace: ""
  # -- Additional labels for ServiceMonitor
  additionalLabels: {}
  # -- Annotations for ServiceMonitor
  annotations: {}
  # -- Scrape interval
  interval: "30s"
  # -- Scrape timeout
  scrapeTimeout: "10s"
  # -- Metric relabelings
  metricRelabelings: []
  # -- Relabelings
  relabelings: []
  # -- Honor labels
  honorLabels: false
  # -- Target labels
  targetLabels: []
  # -- Extra endpoints
  extraEndpoints: []

ingress:
  # -- Enable ingress
  enabled: false
  # -- Ingress class name
  className: ""
  # -- Ingress annotations
  annotations: {}
  # -- Ingress hosts
  hosts:
    - host: metrics-governor.local
      paths:
        - path: /
          pathType: Prefix
          port: stats
  # -- TLS configuration
  tls: []

httpRoute:
  # -- Enable HTTPRoute (Gateway API)
  enabled: false
  # -- Annotations for HTTPRoute
  annotations: {}
  # -- Parent gateway references
  parentRefs: []
  # -- Hostnames for the route
  hostnames: []
  # -- HTTP route rules
  rules: []

podDisruptionBudget:
  # -- Enable PodDisruptionBudget
  enabled: false
  # -- Minimum available pods
  minAvailable: 1
  # -- Maximum unavailable pods (mutually exclusive with minAvailable)
  maxUnavailable: ""
  # -- Annotations for PDB
  annotations: {}
  # -- Labels for PDB
  labels: {}

autoscaling:
  # -- Enable HorizontalPodAutoscaler
  enabled: false
  # -- Minimum replicas
  minReplicas: 1
  # -- Maximum replicas
  maxReplicas: 10
  # -- Target CPU utilization percentage
  targetCPUUtilizationPercentage: 80
  # -- Target memory utilization percentage
  targetMemoryUtilizationPercentage: ""
  # -- Custom metrics for autoscaling
  customMetrics: []
  # -- Scaling behavior
  behavior: {}
  # -- Annotations for HPA
  annotations: {}

persistence:
  # -- Enable persistence (for StatefulSet)
  enabled: false
  # -- Storage class
  storageClassName: ""
  # -- Access modes
  accessModes:
    - ReadWriteOnce
  # -- Storage size
  size: 1Gi
  # -- Annotations for PVC
  annotations: {}
  # -- Selector for PVC
  selector: {}
  # -- Existing claim to use
  existingClaim: ""

# -- Config reload sidecar for automatic ConfigMap change detection
# When enabled, a lightweight sidecar watches config files and sends SIGHUP
# to metrics-governor when changes are detected (e.g. after ConfigMap update).
configReload:
  # -- Enable the configmap-reload sidecar
  enabled: false
  image:
    # -- Sidecar image repository (uses busybox for minimal footprint)
    repository: busybox
    # -- Sidecar image tag
    tag: "1.37"
    # -- Image pull policy
    pullPolicy: IfNotPresent
  # -- Polling interval in seconds for detecting file changes
  watchInterval: 10
  # -- Resources for the sidecar container
  resources:
    requests:
      cpu: 10m
      memory: 16Mi
    limits:
      cpu: 50m
      memory: 32Mi

# -- Extra volumes
extraVolumes: []

# -- Extra volume mounts
extraVolumeMounts: []

# -- Extra containers
extraContainers: []

# -- Init containers
initContainers: []

# -- Resources for the container
resources: {}
  # limits:
  #   cpu: 500m
  #   memory: 512Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# -- Node selector
nodeSelector: {}

# -- Tolerations
tolerations: []

# -- Affinity rules
affinity: {}

# -- Topology spread constraints
topologySpreadConstraints: []

# -- Priority class name
priorityClassName: ""

# -- Termination grace period
terminationGracePeriodSeconds: 30

# -- DNS policy
dnsPolicy: ClusterFirst

# -- DNS config
dnsConfig: {}

# -- Host network
hostNetwork: false

# -- Lifecycle hooks
lifecycle: {}

# -- Liveness probe
# /live returns 200 if the process is running, 503 during shutdown
livenessProbe:
  enabled: true
  httpGet:
    path: /live
    port: stats
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# -- Readiness probe
# /ready checks all pipeline components (receivers, exporters); returns 503 if any are down
readinessProbe:
  enabled: true
  httpGet:
    path: /ready
    port: stats
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

# -- Startup probe
# Uses /live to detect when the process has started
startupProbe:
  enabled: false
  httpGet:
    path: /live
    port: stats
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 30
  successThreshold: 1

# -- Environment variables
env: []

# -- Environment variables from secrets/configmaps
envFrom: []

# -- StatefulSet specific configuration
statefulSet:
  # -- Pod management policy
  podManagementPolicy: OrderedReady
  # -- Update strategy
  updateStrategy:
    type: RollingUpdate

# -- DaemonSet specific configuration
daemonSet:
  # -- Update strategy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

# -- Deployment specific configuration
deployment:
  # -- Update strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# -- Extra Kubernetes objects to create
extraObjects: []
# - apiVersion: v1
#   kind: ConfigMap
#   metadata:
#     name: extra-config
#   data:
#     key: value
