# Default values for metrics-governor
# This is a YAML-formatted file.

# -- Global settings
global:
  # -- Image registry to use for all images
  imageRegistry: ""
  # -- Image pull secrets for all images
  imagePullSecrets: []
  # -- Cluster domain suffix
  clusterDomainSuffix: cluster.local

# -- Number of replicas (ignored for DaemonSet)
replicaCount: 1

# -- Deployment mode: "deployment", "statefulset", or "daemonset"
kind: deployment

image:
  # -- Image registry
  registry: ""
  # -- Image repository
  repository: metrics-governor/metrics-governor
  # -- Image pull policy
  pullPolicy: IfNotPresent
  # -- Image tag (defaults to appVersion)
  tag: ""

# -- Image pull secrets
imagePullSecrets: []

# -- Override the name
nameOverride: ""

# -- Override the fullname
fullnameOverride: ""

# -- Extra labels for all resources
extraLabels: {}

# -- Annotations for all resources
annotations: {}

# -- Pod annotations
podAnnotations: {}

# -- Pod labels
podLabels: {}

serviceAccount:
  # -- Create service account
  create: true
  # -- Annotations for service account
  annotations: {}
  # -- Name of the service account (generated if not set)
  name: ""
  # -- Automount API credentials
  automountServiceAccountToken: true

rbac:
  # -- Create RBAC resources
  create: true
  # -- Create cluster-wide resources
  clusterWide: false
  # -- Extra rules for the role
  extraRules: []
  # -- Annotations for RBAC resources
  annotations: {}

podSecurityContext:
  # -- Run as non-root
  runAsNonRoot: true
  # -- Run as user
  runAsUser: 1000
  # -- Run as group
  runAsGroup: 1000
  # -- FS group
  fsGroup: 1000

securityContext:
  # -- Read only root filesystem
  readOnlyRootFilesystem: true
  # -- Allow privilege escalation
  allowPrivilegeEscalation: false
  # -- Drop all capabilities
  capabilities:
    drop:
      - ALL

# -- Container ports
ports:
  grpc: 4317
  http: 4318
  stats: 9090

# -- metrics-governor configuration
# All application settings are defined in rawConfig as a YAML config file.
# This is mounted as config.yaml into the container.
# See internal/config/yaml.go for the full schema reference.
config:
  # -- Extra CLI arguments (advanced use only; prefer config file settings)
  extraArgs: []
  # -- YAML config file content. This is used verbatim as config.yaml.
  # All receiver, exporter, buffer, queue, performance, and stats settings
  # are configured here. Adjust values below to match your environment.
  rawConfig: |
    receiver:
      grpc:
        address: ":4317"
      http:
        address: ":4318"
    exporter:
      endpoint: "localhost:4317"
      protocol: "grpc"
      insecure: true
      timeout: "30s"
    buffer:
      size: 10000
      batch_size: 1000
      flush_interval: "5s"
      full_policy: "reject"
    memory:
      buffer_percent: 0.15
      queue_percent: 0.15
    queue:
      always_queue: true
      workers: 0              # auto: 2Ã—NumCPU
    stats:
      address: ":9090"
    limits:
      dry_run: true

# -- Receiver TLS configuration
receiverTLS:
  # -- Enable TLS for receivers
  enabled: false
  # -- Secret containing TLS certificate and key
  secretName: ""
  # -- Certificate file key in secret
  certKey: "tls.crt"
  # -- Key file key in secret
  keyKey: "tls.key"
  # -- CA certificate for client verification (mTLS)
  caSecretName: ""
  # -- CA certificate key in secret
  caKey: "ca.crt"
  # -- Require client certificates (mTLS)
  clientAuth: false

# -- Receiver authentication configuration
receiverAuth:
  # -- Enable authentication for receivers
  enabled: false
  # -- Bearer token for authentication (from secret)
  bearerTokenSecretName: ""
  # -- Key in secret containing bearer token
  bearerTokenKey: "token"
  # -- Basic auth username (from secret)
  basicAuthSecretName: ""
  # -- Username key in secret
  usernameKey: "username"
  # -- Password key in secret
  passwordKey: "password"

# -- Exporter TLS configuration
exporterTLS:
  # -- Enable custom TLS config for exporter
  enabled: false
  # -- Secret containing client certificate and key (mTLS)
  secretName: ""
  # -- Certificate file key in secret
  certKey: "tls.crt"
  # -- Key file key in secret
  keyKey: "tls.key"
  # -- CA certificate for server verification
  caSecretName: ""
  # -- CA certificate key in secret
  caKey: "ca.crt"
  # -- Skip TLS certificate verification
  insecureSkipVerify: false
  # -- Override server name for TLS verification
  serverName: ""

# -- Exporter authentication configuration
exporterAuth:
  # -- Bearer token for authentication (from secret)
  bearerTokenSecretName: ""
  # -- Key in secret containing bearer token
  bearerTokenKey: "token"
  # -- Basic auth credentials (from secret)
  basicAuthSecretName: ""
  # -- Username key in secret
  usernameKey: "username"
  # -- Password key in secret
  passwordKey: "password"
  # -- Custom headers for exporter (format: "key1=value1,key2=value2")
  headers: ""

# -- Queue volume management (for Kubernetes volume provisioning only).
# Queue behavior is configured in config.rawConfig under exporter.queue.
queue:
  # -- Enable persistent queue volume (creates emptyDir or uses PVC)
  enabled: false
  # -- Queue storage mount path
  path: "/data/queue"

# -- Limits configuration (creates ConfigMap)
limits:
  # -- Enable limits enforcement
  enabled: false
  # -- Use existing ConfigMap for limits
  existingConfigMap: ""
  # -- Limits configuration content
  config: |
    defaults:
      max_datapoints_rate: 1000000
      max_cardinality: 100000
      action: log
    rules: []

# -- Relabeling configuration (creates ConfigMap)
relabeling:
  # -- Enable metric relabeling
  enabled: false
  # -- Use existing ConfigMap for relabeling
  existingConfigMap: ""
  # -- Relabel configuration content (Prometheus-compatible relabel_configs)
  config: |
    relabel_configs: []

# -- Processing rules configuration (creates ConfigMap)
# Unified processing engine: sample, downsample, aggregate, transform, drop.
# See docs/processing-rules.md for full reference.
processing:
  # -- Enable processing rules (takes precedence over sampling)
  enabled: false
  # -- Use existing ConfigMap for processing
  existingConfigMap: ""
  # -- Processing rules configuration content
  config: |
    staleness_interval: 10m
    rules: []

# -- Sampling configuration (DEPRECATED: use processing instead)
# Kept for backward compatibility. If processing.enabled is true,
# sampling is ignored.
sampling:
  # -- Enable metric sampling
  enabled: false
  # -- Use existing ConfigMap for sampling
  existingConfigMap: ""
  # -- Sampling configuration content
  config: |
    default_rate: 1.0
    strategy: head
    rules: []

# -- Multi-tenancy configuration
tenancy:
  # -- Enable multi-tenancy support
  enabled: false
  # -- Tenant detection mode: "header", "label", or "attribute"
  mode: "header"
  # -- HTTP header name for tenant ID (mode=header, Mimir/Cortex compatible)
  headerName: "X-Scope-OrgID"
  # -- Metric label name for tenant ID (mode=label)
  labelName: "tenant"
  # -- Resource attribute key for tenant ID (mode=attribute)
  attributeKey: "service.namespace"
  # -- Default tenant when detection fails
  defaultTenant: "default"
  # -- Inject tenant ID as a label on all datapoints
  injectLabel: true
  # -- Label name for injected tenant ID
  injectLabelName: "__tenant__"
  # -- Remove source label after detection (mode=label only)
  stripSource: false
  # -- Use existing ConfigMap for tenant quotas
  existingConfigMap: ""
  # -- Tenant quotas configuration content
  config: |
    default:
      max_datapoints: 100000
      max_cardinality: 50000
      action: log
      window: "1m"
    tenants: {}

service:
  # -- Enable service
  enabled: true
  # -- Service type
  type: ClusterIP
  # -- Service annotations
  annotations: {}
  # -- Service labels
  labels: {}
  # -- ClusterIP (leave empty for auto)
  clusterIP: ""
  # -- gRPC port
  grpcPort: 4317
  # -- HTTP port
  httpPort: 4318
  # -- Stats port
  statsPort: 9090
  # -- External traffic policy
  externalTrafficPolicy: ""
  # -- Load balancer IP
  loadBalancerIP: ""
  # -- Load balancer source ranges
  loadBalancerSourceRanges: []

# -- Headless service for StatefulSet
headlessService:
  enabled: true
  annotations: {}

serviceMonitor:
  # -- Enable ServiceMonitor
  enabled: false
  # -- Namespace for ServiceMonitor (defaults to release namespace)
  namespace: ""
  # -- Additional labels for ServiceMonitor
  additionalLabels: {}
  # -- Annotations for ServiceMonitor
  annotations: {}
  # -- Scrape interval
  interval: "30s"
  # -- Scrape timeout
  scrapeTimeout: "10s"
  # -- Metric relabelings
  metricRelabelings: []
  # -- Relabelings
  relabelings: []
  # -- Honor labels
  honorLabels: false
  # -- Target labels
  targetLabels: []
  # -- Extra endpoints
  extraEndpoints: []

alerting:
  # -- Enable PrometheusRule for alert rules
  enabled: false
  # -- Namespace for PrometheusRule (defaults to release namespace)
  namespace: ""
  # -- Additional labels for PrometheusRule (must match Prometheus ruleSelector)
  additionalLabels: {}
  # -- Annotations for PrometheusRule
  annotations: {}
  # -- Alert evaluation interval
  interval: "30s"
  # -- Override individual alert thresholds. Unset values use defaults.
  thresholds:
    # -- Export error rate threshold (0.0-1.0)
    exportErrorRate: 0.1
    # -- Queue utilization threshold (0.0-1.0)
    queueUtilization: 0.85
    # -- Memory usage threshold (0.0-1.0)
    memoryUsage: 0.90
    # -- Backpressure rate (events/sec)
    backpressureRate: 1
    # -- Worker utilization threshold (0.0-1.0)
    workerUtilization: 0.90
    # -- Config staleness (seconds, 86400 = 24h)
    configStaleness: 86400
    # -- Processing duration P99 threshold (seconds, 0.1 = 100ms)
    processingDurationP99: 0.1
    # -- Aggregate group count limit before warning
    aggregateGroupLimit: 100000
    # -- Processing drop rate threshold (0.0-1.0, 0.95 = 95%)
    processingDropRate: 0.95
  # -- Disable specific alerts by name
  disabledAlerts: []
  #   - MetricsGovernorConfigStale
  #   - MetricsGovernorWorkersSaturated
  # -- Additional custom alert rules (raw PrometheusRule rules spec)
  additionalRules: []

ingress:
  # -- Enable ingress
  enabled: false
  # -- Ingress class name
  className: ""
  # -- Ingress annotations
  annotations: {}
  # -- Ingress hosts
  hosts:
    - host: metrics-governor.local
      paths:
        - path: /
          pathType: Prefix
          port: stats
  # -- TLS configuration
  tls: []

httpRoute:
  # -- Enable HTTPRoute (Gateway API)
  enabled: false
  # -- Annotations for HTTPRoute
  annotations: {}
  # -- Parent gateway references
  parentRefs: []
  # -- Hostnames for the route
  hostnames: []
  # -- HTTP route rules
  rules: []

podDisruptionBudget:
  # -- Enable PodDisruptionBudget
  enabled: false
  # -- Minimum available pods
  minAvailable: 1
  # -- Maximum unavailable pods (mutually exclusive with minAvailable)
  maxUnavailable: ""
  # -- Annotations for PDB
  annotations: {}
  # -- Labels for PDB
  labels: {}

autoscaling:
  # -- Enable HorizontalPodAutoscaler
  enabled: false
  # -- Minimum replicas
  minReplicas: 1
  # -- Maximum replicas
  maxReplicas: 10
  # -- Target CPU utilization percentage
  targetCPUUtilizationPercentage: 80
  # -- Target memory utilization percentage
  targetMemoryUtilizationPercentage: ""
  # -- Custom metrics for autoscaling
  customMetrics: []
  # -- Scaling behavior
  behavior: {}
  # -- Annotations for HPA
  annotations: {}

persistence:
  # -- Enable persistence (for StatefulSet)
  enabled: false
  # -- Storage class
  storageClassName: ""
  # -- Access modes
  accessModes:
    - ReadWriteOnce
  # -- Storage size
  size: 1Gi
  # -- Annotations for PVC
  annotations: {}
  # -- Selector for PVC
  selector: {}
  # -- Existing claim to use
  existingClaim: ""

# -- Config reload sidecar for automatic ConfigMap change detection
# When enabled, a lightweight sidecar watches config files and sends SIGHUP
# to metrics-governor when changes are detected (e.g. after ConfigMap update).
configReload:
  # -- Enable the configmap-reload sidecar
  enabled: false
  image:
    # -- Sidecar image repository (uses busybox for minimal footprint)
    repository: busybox
    # -- Sidecar image tag
    tag: "1.37"
    # -- Image pull policy
    pullPolicy: IfNotPresent
  # -- Polling interval in seconds for detecting file changes
  watchInterval: 10
  # -- Resources for the sidecar container
  resources:
    requests:
      cpu: 10m
      memory: 16Mi
    limits:
      cpu: 50m
      memory: 32Mi

# -- Extra volumes
extraVolumes: []

# -- Extra volume mounts
extraVolumeMounts: []

# -- Extra containers
extraContainers: []

# -- Init containers
initContainers: []

# -- Resources for the container
resources: {}
  # limits:
  #   cpu: 500m
  #   memory: 512Mi
  # requests:
  #   cpu: 100m
  #   memory: 128Mi

# -- Node selector
nodeSelector: {}

# -- Tolerations
tolerations: []

# -- Affinity rules
affinity: {}

# -- Topology spread constraints
topologySpreadConstraints: []

# -- Priority class name
priorityClassName: ""

# -- Termination grace period
terminationGracePeriodSeconds: 30

# -- DNS policy
dnsPolicy: ClusterFirst

# -- DNS config
dnsConfig: {}

# -- Host network
hostNetwork: false

# -- Lifecycle hooks
lifecycle: {}

# -- Liveness probe
# /live returns 200 if the process is running, 503 during shutdown
livenessProbe:
  enabled: true
  httpGet:
    path: /live
    port: stats
  initialDelaySeconds: 10
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# -- Readiness probe
# /ready checks all pipeline components (receivers, exporters); returns 503 if any are down
readinessProbe:
  enabled: true
  httpGet:
    path: /ready
    port: stats
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

# -- Startup probe
# Uses /live to detect when the process has started
startupProbe:
  enabled: false
  httpGet:
    path: /live
    port: stats
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 30
  successThreshold: 1

# -- Environment variables
env: []

# -- Environment variables from secrets/configmaps
envFrom: []

# -- StatefulSet specific configuration
statefulSet:
  # -- Pod management policy
  podManagementPolicy: OrderedReady
  # -- Update strategy
  updateStrategy:
    type: RollingUpdate

# -- DaemonSet specific configuration
daemonSet:
  # -- Update strategy
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1

# -- Deployment specific configuration
deployment:
  # -- Update strategy
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0

# -- Extra Kubernetes objects to create
extraObjects: []
# - apiVersion: v1
#   kind: ConfigMap
#   metadata:
#     name: extra-config
#   data:
#     key: value
