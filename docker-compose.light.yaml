# Light testing configuration - moderate volume for development
# Usage: docker compose -f docker-compose.yaml -f docker-compose.light.yaml up -d
#
# This override provides moderate data volume for:
# - Quick functional testing
# - CI/CD pipelines
# - Local development
# - Dashboard validation
#
# Expected: ~5,000-10,000 datapoints/second

services:
  metrics-generator:
    environment:
      - OTLP_ENDPOINT=otel-collector:4317
      - METRICS_INTERVAL=500ms         # Moderate generation rate
      - SERVICES=payment-api,order-api,inventory-api  # 3 services
      - ENVIRONMENTS=prod,staging,dev  # 3 environments
      - ENABLE_EDGE_CASES=false
      - ENABLE_HIGH_CARDINALITY=true   # Enabled with low count
      - ENABLE_BURST_TRAFFIC=false
      - ENABLE_DIVERSE_METRICS=true    # Enabled with low count
      - HIGH_CARDINALITY_COUNT=20      # Low cardinality
      - DIVERSE_METRIC_COUNT=30        # Few diverse metrics
      - BURST_SIZE=100
      - BURST_INTERVAL_SEC=120
      - STATS_INTERVAL_SEC=15
      - TARGET_METRICS_PER_SEC=2000
      - TARGET_DATAPOINTS_PER_SEC=5000
      - METRICS_PORT=9091

  metrics-governor:
    command:
      - "-exporter-endpoint=http://victoriametrics:8428/opentelemetry/v1/metrics"
      - "-exporter-protocol=http"
      - "-exporter-insecure=true"
      - "-exporter-compression=zstd"
      - "-stats-labels=service,env"
      - "-limits-config=/etc/metrics-governor/limits.yaml"
      - "-limits-dry-run=true"
      - "-flush-interval=1s"          # Slower flushing
      - "-batch-size=50"              # Smaller batches
      - "-max-batch-bytes=4194304"    # 4MB conservative byte splitting
      - "-buffer-size=1000"           # Smaller buffer
      # Performance tuning (defaults for development)
      - "-string-interning=true"
      # Queue resilience (conservative for light testing)
      - "-queue-backoff-enabled=true"
      - "-queue-backoff-multiplier=2.0"
      - "-queue-circuit-breaker-enabled=true"
      - "-queue-circuit-breaker-threshold=10"
      - "-queue-circuit-breaker-reset-timeout=30s"
      # Memory limit
      - "-memory-limit-ratio=0.9"

  victoriametrics:
    deploy:
      resources:
        limits:
          memory: 2G                  # Reduced memory
    command:
      - "--storageDataPath=/victoria-metrics-data"
      - "--httpListenAddr=:8428"
      - "--retentionPeriod=1d"        # Minimum retention
      - "--search.latencyOffset=0s"
      - "--promscrape.config=/etc/victoriametrics/scrape.yaml"
      - "--maxInsertRequestSize=16MB"
      - "--opentelemetry.maxRequestSize=16MB"
      - "--opentelemetry.convertMetricNamesToPrometheus"
      - "--memory.allowedPercent=60"
      - "--search.maxUniqueTimeseries=100000"
      - "--search.maxConcurrentRequests=8"
      - "--search.maxQueryDuration=5s"

  verifier:
    environment:
      - VM_ENDPOINT=http://victoriametrics:8428
      - MG_ENDPOINT=http://metrics-governor:9090
      - CHECK_INTERVAL=30s            # Less frequent checks
      - VERIFICATION_METRIC=generator_verification_counter
      - PASS_THRESHOLD=90.0           # Lower threshold for light testing
      - METRICS_PORT=9092
